# 分库分表

## 分表

垂直分表: 不常用字段分离出去

水平分表: 按照特定键将数据保存到不同表



## 全局ID生成策略

一旦分库分表, 必然涉及到全局 id 的生成

#### UUID

组成部分:

当前时间+时钟序列+随机数+全局唯一的IEEE机器识别号。

全局唯一的IEEE机器识别号:如果有网卡，从网卡MAC地址获得，没有网卡以其他方式获得。

缺点:

没有排序, 字符串存储

#### SnowFlake雪花算法

64 位二进制整数

结构: 

​	首位为 0, 表示正数

​	接下来 41 位时间戳, 到毫秒数

​	接下来 10 位机器 id

​	接下来12 位流水号(可以产生4096 个数字)

优点:

​	简单, 按时间递增

缺点:

​	时钟回拨有问题 

​	机器时钟不同步, 非全局递增

改进方案:

生成双 id, 一个是 snowflake, 另一个是一直递增的 int, 作为联合id? 个人认为是可以解决的

或者双 id, 一个是 snowflake, 另一个纯粹是随机数(用什么种子?), 这样可以任意生成, 不必需要单例对象加锁???

#### redis incrby

周期性从 redis 执行`incrby a 100`, 可以每次获得 100 个 id

缺点:

​	引入新组件, redis 单点问题



## 分片策略

####  ID取模分片

缺点：扩容后需要迁移数据。

####  一致性Hash算法



## 扩容方案

#### 停机扩容

不好

#### 平滑扩容

倍数扩容

1. 新增2个数据库

2. 配置双主进行数据同步

3. 数据同步完成之后，配置主主双写, 修改代码, 分片写入

   因为同步有延迟，如果每时每刻都有数据写入/更新的话，就不能准确的保证数据已经同步完成

4. 数据同步完成后, 修改配置, 不再主从

5. 清空原库不属于分片的数据



## 参考

https://zhuanlan.zhihu.com/p/59009462

https://zhuanlan.zhihu.com/p/37792971